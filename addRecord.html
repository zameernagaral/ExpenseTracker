<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Record</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/Assets/favicon/ExpenseTracker/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/Assets/favicon/ExpenseTracker/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/Assets/favicon/ExpenseTracker/favicon-16x16.png">
<link rel="manifest" href="/Assets/favicon/ExpenseTracker/site.webmanifest">
    <style>
        :root {
            --primary: #1976d2;
            --secondary: #43a047;
            --danger: #e53935;
            --background: #f4f6fb;
            --card-bg: #fff;
            --text-main: #22223b;
            --accent: #fbc02d;
            --border: #e0e0e0;
            --shadow: 0 4px 24px rgba(25, 118, 210, 0.08);
        }
        body {
            background: var(--background);
            color: var(--text-main);
            font-family: 'Poppins', Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overscroll-behavior: none;
        }
        .container {
            background: var(--card-bg);
            border-radius: 18px;
            box-shadow: var(--shadow);
            padding: 36px 28px 28px 28px;
            max-width: 400px;
            width: 100%;
            margin: 32px 0;
            display: flex;
            flex-direction: column;
            gap: 18px;
        }
        .container label, .container p {
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--primary);
        }
        .moneybtns {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 8px;
        }
        .moneybtn {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 10px 22px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.18s, transform 0.15s;
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.07);
            outline: none;
        }
        .moneybtn:hover, .moneybtn:focus {
            background: var(--accent);
            color: var(--primary);
            transform: scale(1.06);
        }
        .moneybtn.active {
            background: var(--secondary);
            color: #fff;
        }
        select, input[type="date"], input[type="text"], input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 7px;
            font-size: 1rem;
            background: #fafbfc;
            color: var(--text-main);
            margin-bottom: 4px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        select:focus, input:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 2px #fbc02d33;
        }
        .submit {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
      
::-webkit-scrollbar {
    width: 8px;
    background: var(--background);
}

::-webkit-scrollbar-thumb {
    background: var(--primary);
    border-radius: 8px;
}

      
 
        #submit {
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 12px 36px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.18s, transform 0.15s;
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.07);
        }
        #submit:hover, #submit:focus {
            background: var(--secondary);
            color: #fff;
            transform: scale(1.04);
        }
        .msg {
            min-height: 22px;
            font-size: 1em;
            margin-top: 2px;
            margin-bottom: 2px;
            font-weight: 500;
            letter-spacing: 0.01em;
            transition: color 0.2s;
            text-align: center;
        }
        .msg.error {
            color: var(--danger);
        }
        .msg.success {
            color: var(--secondary);
        }
       
        
        @media (max-width: 500px) {
            .container {
                padding: 16px 4vw 18px 4vw;
                max-width: 98vw;
            }
            .moneybtn {
                padding: 8px 10px;
                font-size: 0.98rem;
            }
        }
        body.dark {
            background: #181a1b;
            color: #f1f1f1;
        }
        body.dark .settings-card {
            background: #23272e;
            color: #f1f1f1;
        }
        body.dark nav {
            background: #23272e;
        }
        body.dark input, body.dark input:focus {
            background: #23272e;
            color: #f1f1f1;
            border-color: #444;
        }
        body.dark li{
            background: #23272e;
            color: #f1f1f1;
            border-color: #444;
        }
        body.dark .container{
            background: #23272e;
            color: #f1f1f1;
        }
        body.dark #account{
            background: #23272e;
            color: #f1f1f1;
        }
        body.dark #TransferTo{
            background: #23272e;
            color: #f1f1f1;
        }
        body.dark #category{
            background: #23272e;
            color: #f1f1f1;
        }
    </style>
</head>
<body>
  <div class="container">
    <h2 style="text-align:center; margin-bottom:18px;">Add Record</h2>
    <div class="msg" id="msg"></div>
    <div>
        <label for="date">Date</label>
        <input type="date" id="date" name="date" required>
    </div>
    <div class="moneybtns" role="group" aria-label="Record type">
        <button class="moneybtn active" id="income" type="button">Income</button>
        <button class="moneybtn" id="expense" type="button">Expense</button>
        <button class="moneybtn" id="transfer" type="button">Transfer</button>
    </div>
    <div>
        <label for="account">Account</label>
        <select id="account"></select>
    </div>
    <div class="transferInput">
        <label for="TransferTo">Transer To</label>
        <select id="TransferTo"></select>
    </div>
    <div>
        <label for="category">Category</label>
        <select id="category"></select>
    </div>
    <div>
        <label for="description">Description <span style="color:var(--text-muted);font-weight:400;">(Optional)</span></label>
        <input type="text" id="description" name="description" maxlength="50" placeholder="E.g. Lunch at cafe">
    </div>
    <div>
        <label for="amount">Amount</label>
        <input type="number" id="amount" name="amount" min="0.01" step="0.01" placeholder="0.00" required>
    </div>
    <div class="submit">
        <button id="submit">Submit</button>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const msg = document.getElementById('msg');
        const username = new URLSearchParams(window.location.search).get('username');
        if (!username) {
            window.location.href = 'unauthorized.html';
            return;
        }
        let transferInput = document.querySelector('.transferInput');
        transferInput.style.display = "none";
        
        // Set today's date as default if not provided
        const dateInput = document.getElementById('date');
        let dateg = new URLSearchParams(window.location.search).get('date');
        dateInput.value = dateg || new Date().toISOString().split('T')[0];

        // Money type buttons
        document.querySelectorAll('.moneybtn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.moneybtn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });
        document.querySelectorAll('.moneybtn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (btn.textContent === "Transfer") {
                    transferInput.style.display = "block";

                }
                else {
                    transferInput.style.display = "none";
                }
            });
        });

        // Populate account and category dropdowns
        const categoryValue = document.getElementById('category');
        const accountValue = document.getElementById('account');
        let categoryData = JSON.parse(localStorage.getItem("categoryData")) || [];
        let accountData = JSON.parse(localStorage.getItem("accountData")) || [];
        let categoryFind = categoryData.find(c => c.username === username);
        let accountFind = accountData.find(c => c.username === username);
        let transferTo = document.getElementById('TransferTo');
        

        // Helper: Show message
        function showMsg(message, type = "error") {
            msg.textContent = message;
            msg.className = "msg " + type;
        }
        function clearMsg() {
            msg.textContent = "";
            msg.className = "msg";
        }

        // Populate categories
        categoryValue.innerHTML = '';
        if (categoryFind && Array.isArray(categoryFind.items) && categoryFind.items.length > 0) {
            categoryFind.items.forEach(item => {
                let option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                categoryValue.appendChild(option);
            });
        } else {
            let option = document.createElement('option');
            option.value = "";
            option.textContent = "No categories found";
            categoryValue.appendChild(option);
            categoryValue.disabled = true;
        }

        // Populate accounts
        accountValue.innerHTML = '';
        if (accountFind && Array.isArray(accountFind.items) && accountFind.items.length > 0) {
            accountFind.items.forEach(item => {
                let option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                accountValue.appendChild(option);
                

            });
            accountFind.items.forEach(item => {
                let option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                transferTo.appendChild(option);
                

            });
        } else {
            let option = document.createElement('option');
            option.value = "";
            option.textContent = "No accounts found";
            accountValue.appendChild(option);
            accountValue.disabled = true;
        }

        // Focus first input
        setTimeout(() => {
            if (!accountValue.disabled) accountValue.focus();
            else if (!categoryValue.disabled) categoryValue.focus();
            else dateInput.focus();
        }, 100);

        // Submit handler
        document.getElementById('submit').addEventListener('click', handleSubmit);
        document.addEventListener('keydown', function(e) {
            if (e.key === "Enter" && (document.activeElement.tagName !== "TEXTAREA")) {
                handleSubmit();
            }
        });

        function handleSubmit() {
            clearMsg();
            const amount = document.getElementById('amount').value.trim();
            const date1 = dateInput.value;
            const account = accountValue.value;
            const category = categoryValue.value;
            const description = document.getElementById('description').value.trim();
            const type = document.querySelector('.moneybtn.active').id;

            // Validation
            if (!date1) {
                showMsg("Please select a date.");
                dateInput.focus();
                return;
            }
            if (accountValue.disabled) {
                showMsg("Please add an account first.");
                return;
            }
            if (categoryValue.disabled) {
                showMsg("Please add a category first.");
                return;
            }
            if (!amount || isNaN(amount) || Number(amount) <= 0) {
                showMsg("Please enter a valid amount.");
                document.getElementById('amount').focus();
                return;
            }
            if (description.length > 50) {
                showMsg("Description is too long. Please limit it to 50 characters.");
                document.getElementById('description').focus();
                return;
            }

            let record = localStorage.getItem('record') ? JSON.parse(localStorage.getItem('record')) : [];
            let recordFind = record.find(r => r.username === username && r.date === date1);

            if (recordFind) {
                recordFind.account.push(account);
                recordFind.category.push(category);
                recordFind.description.push(description);
                recordFind.amount.push(amount);
                recordFind.type.push(type);
            } else {
                const newRecord = {
                    username: username,
                    date: date1,
                    type: [type],
                    account: [account],
                    category: [category],
                    description: [description],
                    amount: [amount]
                };
                record.push(newRecord);
            }
            localStorage.setItem('record', JSON.stringify(record));
            
            setTimeout(() => {
                window.location.href = 'success.html?username=' + encodeURIComponent(username);
            }, 700);
        }
        if (localStorage.getItem("darkMode") === "on") {
                document.body.classList.add("dark");
            }
            else
            {
                document.body.classList.remove("dark");
            }
    });
  </script>
</body>
</html>